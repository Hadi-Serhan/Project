<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mage Core</title>

  <link rel="stylesheet" href="./style.css">
  <link rel="icon" href="data:,"> 
</head>
<body>
<div id="wrap">
  <canvas id="game"></canvas>

  <!-- Vue UI (everything reactive lives inside #app) -->
  <div id="app" class="ui">

    <!-- Top HUD -->
    <div class="hud">
      <div class="hud-group">
        <span class="tag">Wave</span>
        <span class="hud-val">{{ wave }}</span>
      </div>
      <div class="hud-group">
        <span class="tag">Core HP</span>
        <span class="hud-val">{{ coreHP }}</span>
      </div>
      <div class="hud-group">
        <span class="tag">Gold</span>
        <span class="hud-val">{{ gold }}</span>
      </div>
      <div class="hud-status">{{ waveStatus }}</div>
    </div>

    <!-- Controls -->
    <div class="card controls">
      <div class="row wrap">
        <button class="btn primary" @click="startWave" :disabled="waveRunning || defeated">Start Wave</button>

        <button class="btn" :class="{warning: paused}" @click="togglePause">
          {{ paused ? 'Resume' : 'Pause' }}
        </button>

        <label class="control">
          <span class="lbl">Speed</span>
          <select v-model.number="timeScale" @change="setSpeed(timeScale)">
            <option :value="1">x1</option>
            <option :value="2">x2</option>
            <option :value="3">x3</option>
            <option :value="4">x4</option>
          </select>
        </label>

        <label class="control chk">
          <input type="checkbox" v-model="autoStart" @change="setAutoStart(autoStart)" />
          <span>Auto-start next wave</span>
        </label>

        <button class="btn ghost" @click="reset">Reset</button>
      </div>

      <div class="row wrap">
        <button class="btn ghost" @click="saveNow">Save</button>
        <button class="btn ghost" @click="loadSave" :disabled="!hasSave">Load</button>
        <button class="btn ghost danger" @click="wipeSave" :disabled="!hasSave">Wipe</button>
        <span class="meta">Last saved: {{ lastSavedLabel }}</span>
      </div>
    </div>

    <!-- Upgrades -->
    <div class="card">
      <h3>Upgrades</h3>

      <!-- Tabs -->
      <div class="row wrap" style="gap:6px; margin-bottom:8px">
        <button
          v-for="tab in upgradeTabs" :key="tab"
          class="btn"
          :class="{ primary: tab === selectedUpgradeTab }"
          @click="selectUpgradeTab(tab)">
          {{ tab }}
        </button>
      </div>

      <!-- Filtered list -->
      <div class="grid3">
        <div class="upgrade" v-for="u in filteredUpgrades" :key="u.id">
          <div class="u-title">{{ u.title }}</div>
          <div class="meta" v-if="u.desc">{{ u.desc }}</div>

          <!-- NEW: live stat readout from state.js (modular) -->
          <div class="meta text-xs opacity-75" v-if="u.readout">{{ u.readout }}</div>

          <button class="btn block" @click="buy(u.id)" :disabled="gold < u.cost">
            Buy ({{ Number(u.cost).toLocaleString() }})
          </button>
        </div>
      </div>
    </div>

    <!-- Abilities -->
    <div class="card">
      <h3>Abilities</h3>

      <!-- Tabs -->
      <div class="row wrap" style="gap:6px; margin-bottom:8px">
        <button
          v-for="tab in abilityTabs" :key="tab"
          class="btn"
          :class="{ primary: tab === selectedAbilityTab }"
          @click="selectAbilityTab(tab)">
          {{ tab }}
        </button>
      </div>

      <!-- Filtered buttons -->
      <div class="row wrap">
        <button class="btn ability"
                v-for="a in filteredAbilities" :key="a.id"
                :class="{cooling: a.cdLeft > 0}"
                @click="cast(a.id)"
                :disabled="a.cdLeft > 0 || !a.enabled">
          {{ a.title }} <span class="hint" v-if="a.hint">({{ a.hint }})</span>
          <span class="cooldown" v-if="a.cdLeft > 0">{{ a.cdLeft.toFixed(1) }}s</span>
        </button>
      </div>
    </div>

  </div><!-- /#app -->
</div><!-- /#wrap -->

<!-- Vue -->
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

<!-- Bootstrap: load mods first, then the game and UI -->
<script type="module">
  // Ensure Engine exists globally before mods run
  import Engine from './mage-core/src/engine.js';
  window.Engine = Engine;
  window.engine = {};

  // 1) Load all mods (reads ./mage-core/mods/mod-list.json)
  import { loadAllMods } from './mage-core/src/mod-loader.js';
  await loadAllMods();

  // 2) Boot the engine/game
  await import('./mage-core/src/main.js');

  // 3) Mount the Vue UI (dynamic lists; no hardcoded abilities/upgrades)
  await import('./mage-core/src/ui/vue-app.js');
</script>
</body>
</html>
